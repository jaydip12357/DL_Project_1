<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload X-Rays - MediAlert</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            color: #1e293b;
            background: #f8fafc;
        }

        .upload-navbar {
            position: sticky;
            top: 0;
            background: rgba(255, 255, 255, 0.97);
            backdrop-filter: blur(8px);
            border-bottom: 1px solid #e2e8f0;
            padding: 0.875rem 0;
            z-index: 1000;
        }

        .upload-navbar-inner {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .upload-navbar a.logo-link {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
            font-size: 1.25rem;
            font-weight: 700;
            color: #0e4f8b;
        }

        .upload-nav-links {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .upload-nav-links a {
            text-decoration: none;
            color: #64748b;
            font-weight: 500;
            font-size: 0.9rem;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            transition: color 0.2s, background 0.2s;
        }

        .upload-nav-links a:hover {
            color: #0e4f8b;
            background: #f0f9ff;
        }

        .upload-nav-links a.active {
            color: #0e4f8b;
            background: #f0f9ff;
        }

        .upload-header {
            background: linear-gradient(135deg, #0a3d6b 0%, #0e4f8b 100%);
            color: white;
            padding: 2rem;
            margin-bottom: 2rem;
            border-radius: 8px;
        }

        .upload-header h1 {
            margin: 0 0 0.5rem 0;
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
        }

        .upload-header p {
            margin: 0;
            color: rgba(255, 255, 255, 0.85);
            font-size: 0.95rem;
        }

        .upload-container {
            max-width: 700px;
            margin: 0 auto;
        }

        .section {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
            border: 1px solid #e2e8f0;
        }

        .section h2 {
            color: #0e4f8b;
            margin: 0 0 1.5rem 0;
            font-size: 1.15rem;
            font-weight: 600;
        }

        .dropzone {
            border: 2px dashed #cbd5e1;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.2s, background 0.2s;
            background: #f8fafc;
        }

        .dropzone:hover {
            border-color: #0e4f8b;
            background: #f0f9ff;
        }

        .dropzone.dragover {
            border-color: #0e4f8b;
            background: #e0f2fe;
        }

        .dropzone-icon { font-size: 3rem; margin-bottom: 1rem; }
        .dropzone-text { color: #0e4f8b; font-weight: 600; margin-bottom: 0.25rem; }
        .dropzone-subtext { color: #64748b; font-size: 0.9rem; margin-bottom: 1rem; }
        .dropzone-formats { color: #94a3b8; font-size: 0.85rem; }

        #fileInput { display: none; }

        .preview-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .preview-item {
            position: relative;
            background: #f8fafc;
            border-radius: 6px;
            overflow: hidden;
            aspect-ratio: 1;
        }

        .preview-item img { width: 100%; height: 100%; object-fit: cover; }

        .preview-remove {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: rgba(220, 38, 38, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .preview-remove:hover { background: #dc2626; }

        .form-group { margin-bottom: 1.5rem; }

        label {
            display: block;
            margin-bottom: 0.5rem;
            color: #1e293b;
            font-weight: 500;
            font-size: 0.9rem;
        }

        select, input[type="text"] {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.95rem;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        select:focus, input[type="text"]:focus {
            outline: none;
            border-color: #0e4f8b;
            box-shadow: 0 0 0 3px rgba(14, 79, 139, 0.1);
        }

        .checkbox-group { display: flex; flex-wrap: wrap; gap: 1rem; }

        .checkbox-item { display: flex; align-items: center; }
        .checkbox-item input { width: auto; margin-right: 0.5rem; }
        .checkbox-item label { margin: 0; font-weight: normal; }

        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 2rem;
        }

        .btn {
            padding: 0.875rem;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
            font-family: 'Inter', sans-serif;
        }

        .btn-primary { background: #0e4f8b; color: white; }
        .btn-primary:hover { background: #0a3d6b; }
        .btn-primary:disabled { background: #cbd5e1; cursor: not-allowed; }
        .btn-secondary { background: #e2e8f0; color: #1e293b; }
        .btn-secondary:hover { background: #cbd5e1; }

        .disclaimer-box {
            background: #fef3c7;
            border: 1px solid #fcd34d;
            border-radius: 6px;
            padding: 1rem;
            color: #92400e;
            font-size: 0.9rem;
            margin-bottom: 1.5rem;
        }

        .status-message {
            padding: 1rem;
            border-radius: 6px;
            margin-top: 1rem;
            display: none;
        }

        .status-message.success { background: #ecfdf5; color: #065f46; display: block; }
        .status-message.error { background: #fef2f2; color: #7f1d1d; display: block; }

        .loading {
            display: none;
            text-align: center;
            color: #0e4f8b;
            margin-top: 1rem;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #0e4f8b;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            margin-right: 0.5rem;
            vertical-align: middle;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .results-inline {
            margin-top: 1.5rem;
            display: none;
        }

        .results-inline.show { display: block; }

        .result-inline-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1.25rem;
            margin-bottom: 1rem;
        }

        .result-inline-card h4 {
            color: #0e4f8b;
            margin: 0 0 0.75rem 0;
            font-size: 1rem;
        }

        .result-prediction-tag {
            display: inline-block;
            padding: 0.35rem 0.85rem;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.85rem;
            margin-right: 0.5rem;
        }

        .result-prediction-tag.normal { background: #ecfdf5; color: #065f46; }
        .result-prediction-tag.pneumonia { background: #fef3c7; color: #92400e; }

        .severity-tag {
            display: inline-block;
            padding: 0.2rem 0.6rem;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .severity-tag.mild { background: #ecfdf5; color: #065f46; }
        .severity-tag.moderate { background: #fef3c7; color: #92400e; }
        .severity-tag.severe { background: #fef2f2; color: #7f1d1d; }

        .confidence-bar-inline {
            margin-top: 0.75rem;
        }

        .confidence-label-inline {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.25rem;
            font-size: 0.8rem;
            color: #64748b;
        }

        .progress-bar-inline {
            width: 100%;
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill-inline {
            height: 100%;
            background: #0e4f8b;
            border-radius: 3px;
        }

        .result-meta-inline {
            font-size: 0.8rem;
            color: #64748b;
            margin-top: 0.5rem;
        }

        .upload-footer {
            background: #1e293b;
            color: #94a3b8;
            padding: 1.5rem;
            text-align: center;
            font-size: 0.85rem;
            margin-top: 2rem;
        }
    </style>
</head>
<body>
    <nav class="upload-navbar">
        <div class="upload-navbar-inner">
            <a href="/" class="logo-link">MediAlert</a>
            <div class="upload-nav-links">
                <a href="/hospital/dashboard">Dashboard</a>
                <a href="/hospital/upload" class="active">Upload X-rays</a>
                <a href="/surveillance">India Dashboard</a>
            </div>
        </div>
    </nav>

    <main style="max-width: 1200px; margin: 0 auto; padding: 2rem;">
        <div class="upload-container">
            <div class="upload-header">
                <h1>Upload X-Ray Images</h1>
                <p>Drag and drop chest X-ray images for AI analysis</p>
            </div>

            <div class="disclaimer-box">
                <strong>Medical Disclaimer:</strong> MediAlert is for educational and research purposes only.
                AI predictions should be reviewed by qualified radiologists.
            </div>

            <form id="uploadForm">
                <div class="section">
                    <h2>Select Images</h2>

                    <div class="dropzone" id="dropzone">
                        <div class="dropzone-icon">&#9729;</div>
                        <div class="dropzone-text">Drag and drop files here</div>
                        <div class="dropzone-subtext">or click to browse</div>
                        <div class="dropzone-formats">Supported: JPG, PNG (max 10MB each)</div>
                    </div>

                    <input type="file" id="fileInput" multiple accept=".jpg,.jpeg,.png">
                    <div class="preview-container" id="previewContainer"></div>
                </div>

                <div class="button-group">
                    <button type="button" class="btn btn-secondary" onclick="window.history.back()">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="submitBtn" disabled>Analyze Images</button>
                </div>

                <div class="loading" id="loading">
                    <span class="spinner"></span>
                    <span>Analyzing images...</span>
                </div>

                <div class="status-message" id="statusMessage"></div>
            </form>

            <div class="results-inline" id="resultsInline">
                <div class="section">
                    <h2>Analysis Results</h2>
                    <div id="resultsContainer"></div>
                    <div style="margin-top: 1.5rem; display: flex; gap: 1rem;">
                        <a href="/hospital/upload" class="btn btn-primary" style="text-decoration: none; text-align: center; flex: 1; display: inline-block;">Analyze More Images</a>
                        <a href="/hospital/dashboard" class="btn btn-secondary" style="text-decoration: none; text-align: center; flex: 1; display: inline-block;">Back to Dashboard</a>
                    </div>
                </div>
            </div>

            <div class="section" style="margin-top: 2rem; background: #f0f9ff; border-left: 4px solid #0e4f8b;">
                <h3 style="color: #0e4f8b; margin: 0 0 0.5rem 0; font-size: 1rem;">How It Works</h3>
                <ol style="color: #0c4a6e; margin: 0; padding-left: 1.5rem; font-size: 0.9rem; line-height: 1.8;">
                    <li>Upload one or more chest X-ray images</li>
                    <li>Click "Analyze Images"</li>
                    <li>AI analyzes each image in 2-5 seconds</li>
                    <li>View results with confidence scores and clinical analysis</li>
                    <li>No images or patient data are stored — results are shown in real-time only</li>
                </ol>
            </div>
        </div>
    </main>

    <div class="upload-footer">
        <p>&copy; 2026 MediAlert Hospital Portal</p>
    </div>

    <script>
        const dropzone = document.getElementById('dropzone');
        const fileInput = document.getElementById('fileInput');
        const previewContainer = document.getElementById('previewContainer');
        const uploadForm = document.getElementById('uploadForm');
        const submitBtn = document.getElementById('submitBtn');
        const statusMessage = document.getElementById('statusMessage');
        const loading = document.getElementById('loading');
        const resultsInline = document.getElementById('resultsInline');
        const resultsContainer = document.getElementById('resultsContainer');
        let selectedFiles = [];

        // Dropzone events
        dropzone.addEventListener('click', () => fileInput.click());

        dropzone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropzone.classList.add('dragover');
        });

        dropzone.addEventListener('dragleave', () => {
            dropzone.classList.remove('dragover');
        });

        dropzone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropzone.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        function handleFiles(files) {
            selectedFiles = Array.from(files).filter(file =>
                file.type.match(/image\/(jpg|jpeg|png)/)
            );

            if (selectedFiles.length === 0) {
                statusMessage.textContent = 'Please select JPG or PNG images.';
                statusMessage.className = 'status-message error';
                return;
            }

            statusMessage.className = 'status-message';
            updatePreview();
            updateSubmitBtn();
        }

        function updatePreview() {
            previewContainer.innerHTML = '';
            selectedFiles.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const preview = document.createElement('div');
                    preview.className = 'preview-item';
                    preview.innerHTML = `
                        <img src="${e.target.result}" alt="Preview ${index}">
                        <button type="button" class="preview-remove" onclick="removeFile(${index})">&#10005;</button>
                    `;
                    previewContainer.appendChild(preview);
                };
                reader.readAsDataURL(file);
            });
        }

        function removeFile(index) {
            selectedFiles.splice(index, 1);
            updatePreview();
            updateSubmitBtn();
        }

        function updateSubmitBtn() {
            submitBtn.disabled = selectedFiles.length === 0;
        }

        function renderResults(results) {
            resultsContainer.innerHTML = '';
            results.forEach((result, index) => {
                const card = document.createElement('div');
                card.className = 'result-inline-card';

                // Handle skipped or error results
                if (result.status === 'error' || result.status === 'skipped') {
                    card.innerHTML = `
                        <h4>Image #${index + 1} — ${result.filename || 'Unknown'}</h4>
                        <div style="color: #dc2626; background: #fef2f2; padding: 0.75rem; border-radius: 6px; font-size: 0.9rem;">
                            ${result.error || 'Analysis failed. Please try again.'}
                        </div>
                    `;
                    resultsContainer.appendChild(card);
                    return;
                }

                const predClass = result.prediction === 'PNEUMONIA' ? 'pneumonia' : 'normal';
                const severityClass = result.severity || 'mild';
                const confidence = (result.confidence * 100).toFixed(1);
                const isFallback = result.source === 'fallback';

                let html = `
                    <h4>Image #${index + 1} — ${result.filename || 'Chest X-Ray'}</h4>
                    ${isFallback ? '<div style="background:#fef3c7; color:#92400e; padding:0.5rem 0.75rem; border-radius:6px; font-size:0.8rem; margin-bottom:0.75rem;">Note: AI model API is currently unavailable. Showing simulated analysis for demo purposes.</div>' : ''}
                    <span class="result-prediction-tag ${predClass}">${result.prediction}</span>
                    <span class="severity-tag ${severityClass}">${severityClass.charAt(0).toUpperCase() + severityClass.slice(1)}</span>
                    <div class="confidence-bar-inline">
                        <div class="confidence-label-inline">
                            <span>Confidence</span>
                            <span>${confidence}%</span>
                        </div>
                        <div class="progress-bar-inline">
                            <div class="progress-fill-inline" style="width: ${confidence}%"></div>
                        </div>
                    </div>
                `;

                // Show clinical analysis
                if (result.analysis) {
                    const analysisBg = result.prediction === 'PNEUMONIA' ? '#fef2f2' : '#ecfdf5';
                    const analysisColor = result.prediction === 'PNEUMONIA' ? '#7f1d1d' : '#065f46';
                    const analysisBorder = result.prediction === 'PNEUMONIA' ? '#fecaca' : '#a7f3d0';
                    html += `
                        <div style="margin-top:1rem; padding:1rem; background:${analysisBg}; border:1px solid ${analysisBorder}; border-radius:6px;">
                            <div style="font-weight:600; color:${analysisColor}; margin-bottom:0.5rem; font-size:0.9rem;">Clinical Analysis</div>
                            <div style="color:${analysisColor}; font-size:0.85rem; line-height:1.6;">${result.analysis}</div>
                        </div>
                    `;
                }

                // Show probabilities if available
                if (result.probabilities && Object.keys(result.probabilities).length > 0) {
                    html += `<div style="margin-top:0.75rem; font-size:0.8rem; color:#64748b;">`;
                    for (const [label, prob] of Object.entries(result.probabilities)) {
                        html += `<span style="margin-right:1rem;">${label}: ${(prob * 100).toFixed(1)}%</span>`;
                    }
                    html += `</div>`;
                }

                if (result.processing_time_ms) {
                    html += `<div class="result-meta-inline">Analyzed in ${result.processing_time_ms}ms | Model: ${result.model_version || 'v1.0'}</div>`;
                }

                card.innerHTML = html;
                resultsContainer.appendChild(card);
            });
            resultsInline.classList.add('show');
        }

        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (selectedFiles.length === 0) return;

            loading.style.display = 'block';
            submitBtn.disabled = true;
            statusMessage.className = 'status-message';
            resultsInline.classList.remove('show');

            const formData = new FormData();
            selectedFiles.forEach(file => {
                formData.append('images', file);
            });

            try {
                const response = await fetch('/hospital/upload', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.status === 401) {
                    // Session expired - server returns JSON 401
                    statusMessage.textContent = 'Session expired. Please log in again.';
                    statusMessage.className = 'status-message error';
                    setTimeout(() => {
                        window.location.href = '/hospital/login';
                    }, 2000);
                    return;
                }

                if (response.ok) {
                    const succeeded = (data.results || []).filter(r => r.status === 'success').length;
                    const skipped = (data.results || []).filter(r => r.status === 'skipped').length;
                    const fallbackCount = (data.results || []).filter(r => r.source === 'fallback').length;

                    let msg = `Successfully analyzed ${succeeded} image(s).`;
                    if (skipped) msg += ` ${skipped} skipped.`;
                    if (fallbackCount > 0 && fallbackCount === succeeded) {
                        msg += ' (Demo mode — AI model API unavailable)';
                    }
                    statusMessage.textContent = msg;
                    statusMessage.className = 'status-message success';

                    // Show results inline
                    if (data.results && data.results.length > 0) {
                        renderResults(data.results);
                    }

                    selectedFiles = [];
                    previewContainer.innerHTML = '';
                    updateSubmitBtn();
                } else {
                    statusMessage.textContent = 'Error: ' + (data.error || 'Failed to analyze images.');
                    statusMessage.className = 'status-message error';
                }
            } catch (error) {
                statusMessage.textContent = 'Network error. Please check your connection and try again.';
                statusMessage.className = 'status-message error';
            } finally {
                loading.style.display = 'none';
                submitBtn.disabled = false;
            }
        });
    </script>
</body>
</html>
